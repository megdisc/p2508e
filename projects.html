<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>案件管理</title>
    
    <link rel="stylesheet" href="colors.css">
    <link rel="stylesheet" href="style.css">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">

    </head>
<body data-page-key="PROJECTS">

    <div class="app-layout">
        
        <aside class="sidebar">
            <div class="logo">p2508e</div>
            <nav class="global-nav"></nav>
            

            <div class="sidebar-footer">
                <div class="user-name">山田太郎</div>
                <div class="user-role">管理者</div>
                <div class="sidebar-logout">
                    <a href="#">ログアウト</a>
                </div>
            </div>
        </aside>

        <main class="main-content">
            
            <div class="header-with-actions">
                <h1></h1> 
                <div class="action-buttons">
                    <button class="btn btn-icon btn-primary" title="新規案件登録">
                        <span class="material-symbols-outlined">add</span>
                    </button>
                </div>
            </div>

            <div class="controls">
                
                <div class="search-filter">
                    <input type="search" id="projectSearch" placeholder="案件名、顧客名、担当者名などで検索...">
                </div>

                <div class="view-toggle-icons" role="radiogroup" aria-label="表示切替">
                    <button class="btn-icon view-toggle-btn active" data-view-target="view-cards" title="カード表示" aria-checked="true">
                        <span class="material-symbols-outlined">list</span>
                    </button>
                    <button class="btn-icon view-toggle-btn" data-view-target="view-schedule" title="スケジュール表示" aria-checked="false">
                        <span class="material-symbols-outlined">gantt_chart</span>
                    </button>
                    <button class="btn-icon view-toggle-btn" data-view-target="view-budget" title="予算表示" aria-checked="false">
                        <span class="material-symbols-outlined">monetization_on</span>
                    </button>
                </div>
            </div>
            
            <div class="view-content-area">

                <div id="view-cards" class="view-content active">
                    <div id="project-card-container" class="card-list-container">
                        </div>
                </div>

                <div id="view-schedule" class="view-content">
                    <div class="gantt-chart-container">
                        <div id="gantt-chart-grid" class="gantt-chart">
                            </div>
                    </div>
                </div>

                <div id="view-budget" class="view-content">
                    <div class="data-table-container">
                        <table id="budget-table" class="data-table budget-table">
                            </table>
                    </div>
                </div>

                </div>
            </main>
    </div>

    <script>
        // --- モックデータ定義 (projects.html のデータ) ---
        
        const PROJECT_STATUS = {
            NOT_STARTED: { text: '未着手', class: 'status-not-started' },
            ACTIVE: { text: '進行中', class: 'status-active' },
            COMPLETED: { text: '完了', class: 'status-completed' },
            CANCELLED: { text: '中止', class: 'status-cancelled' }
        };

        const projectsMockData = [
             {
                id: 'P-001',
                name: '箱折り',
                status: PROJECT_STATUS.ACTIVE,
                client: '株式会社S',
                type: '外部受託', 
                frequency: '継続', 
                manager: '山田 太郎',
                orderDate: '2025-10-20',
                deadline: '2025-11-20',
                budget: 150000,
                actual: 95000,
                tasks: [
                    { name: '型抜き', progress: 100, period: '1 - 5日', assignee: { name: '鈴木 花子', type: '利用者' } },
                    { name: '組み立て', progress: 60, period: '5 - 10日', assignee: { name: '鈴木 花子', type: '利用者' } },
                    { name: '検品・梱包', progress: 0, period: '10 - 12日', assignee: { name: '山田 太郎', type: '職員' } }
                ]
            },
            {
                id: 'P-002',
                name: 'DM検品・封入',
                status: PROJECT_STATUS.ACTIVE,
                client: 'M商事',
                type: '外部受託', 
                frequency: '単発', 
                manager: '佐藤 一郎',
                orderDate: '2025-11-01',
                deadline: '2025-11-15',
                budget: 80000,
                actual: 85000,
                tasks: [
                    { name: '汚れ確認', progress: 30, period: '1 - 2日', assignee: { name: '佐藤 一郎', type: '職員' } },
                    { name: '封入', progress: 0, period: '3 - 5日', assignee: { name: '鈴木 花子', type: '利用者' } }
                ]
            },
            {
                id: 'P-003',
                name: 'Webアイコン制作',
                status: PROJECT_STATUS.COMPLETED,
                client: 'N工業 (Web部)',
                type: '外部受託', 
                frequency: '単発', 
                manager: '高橋 次郎',
                orderDate: '2025-10-01',
                deadline: '2025-10-31',
                budget: 120000,
                actual: 120000,
                tasks: [
                    { name: 'デザイン案', progress: 100, period: '1 - 10日', assignee: { name: '高橋 次郎', type: '外注先' } },
                    { name: 'SVGデータ化', progress: 100, period: '11 - 15日', assignee: { name: '高橋 次郎', type: '外注先' } }
                ]
            },
            { 
                id: 'P-004',
                name: '自主製品 (クッキー) 製造',
                status: PROJECT_STATUS.NOT_STARTED,
                client: 'ー (自主事業)',
                type: '自主事業', 
                frequency: '継続', 
                manager: '山田 太郎',
                orderDate: '2025-12-01',
                deadline: '2025-12-05',
                budget: 50000,
                actual: 0,
                tasks: [
                    { name: '生地準備', progress: 0, period: '1日', assignee: { name: '厨房チーム', type: '利用者' } },
                    { name: '焼成・梱包', progress: 0, period: '2日', assignee: { name: '厨房チーム', type: '利用者' } }
                ]
            },
            { 
                id: 'P-005',
                name: '公園清掃 (契約)',
                status: PROJECT_STATUS.CANCELLED,
                client: 'A市役所',
                type: '外部受託', 
                frequency: '継続', 
                manager: '佐藤 一郎',
                orderDate: '2025-10-01',
                deadline: '2026-03-31',
                budget: 300000,
                actual: 25000,
                tasks: [
                    { name: '月次清掃', progress: 10, period: '毎月', assignee: { name: '清掃チーム', type: '利用者' } }
                ]
            }
        ];


        // --- 既存のDOM要素 ---
        const cardContainer = document.getElementById('project-card-container');

        // --- 既存のレンダリング関数 (カード表示用) ---
        function createTaskProgressBar(progress) {
            return `
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-bar-inner" style="width: ${progress}%;"></div>
                    </div>
                    <span class="progress-percentage">${progress}%</span>
                </div>
            `;
        }
        function createTaskRow(task) {
            return `
                <div class="task-row">
                    <span class="task-name">${task.name}</span>
                    <span class="task-period">${task.period || ''}</span>
                    <span class="task-assignee">
                        ${task.assignee.name}
                        <span class="assignee-type">${task.assignee.type}</span>
                    </span>
                    <div class="task-gauge">
                        ${createTaskProgressBar(task.progress)}
                    </div>
                </div>
            `;
        }
        function formatDateShort(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                return `${parts[1].padStart(2, '0')}/${parts[2].padStart(2, '0')}`;
            }
            return dateString;
        }

        function renderProjectCards() {
            let containerHtml = '';
            projectsMockData.forEach(p => {
                let tasksHtml = p.tasks.map(createTaskRow).join('');
                let periodHtml = `${formatDateShort(p.orderDate)} - ${formatDateShort(p.deadline)}`;
                let typeBadgeText = p.type === '外部受託' ? `${p.type} (${p.client})` : p.type;
                containerHtml += `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-header-info">
                                <span class="status-badge ${p.status.class} status-badge-large">${p.status.text}</span>
                                <div class="title-wrapper">
                                    <h2 class="card-title">${p.name}</h2>
                                    <div class="project-badges-stack">
                                        <span class="project-category-badge">${typeBadgeText}</span>
                                        <span class="project-category-badge">${p.frequency}</span>
                                    </div>
                                </div>
                                <p class="card-subtitle">${p.client}</p>
                            </div>
                            <div class="card-header-aside">
                                <button class="btn btn-icon" title="編集">
                                    <span class="material-symbols-outlined">edit</span> </button>
                                <button class="btn btn-icon btn-danger" title="削除">
                                    <span class="material-symbols-outlined">delete</span> </button>
                            </div>
                        </div>
                        <div class="card-body-columns">
                            <div class="card-section-detail"> 
                                <p class="card-meta-item">${periodHtml}</p>
                                <p class="card-meta-item">${p.manager}</p>
                            </div>
                            <div class="card-section-task">
                                <div class="task-list-wrapper">
                                    ${tasksHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            cardContainer.innerHTML = containerHtml;
        }


        // --- 新規ビュー描画関数 ---

        // 日付ユーティリティ (Dateオブジェクトを 'YYYY-MM-DD' 文字列に)
        function toISODateString(date) {
            return date.toISOString().split('T')[0];
        }
        // 2つの日付間の日数を計算
        function daysBetween(dateStr1, dateStr2) {
            const d1 = new Date(dateStr1);
            const d2 = new Date(dateStr2);
            const diffTime = Math.abs(d2 - d1);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }


        /**
         * 2. スケジュール (ガントチャート) 描画
         */
        function renderGanttChart() {
            const container = document.getElementById('gantt-chart-grid');
            
            // --- ガントチャートの期間設定 ---
            // (ここではモックデータに基づき 10/20 から 31 日間 (11/19 まで) とします)
            const ganttStartDate = new Date('2025-10-20');
            const ganttTotalDays = 31;
            const timelineDates = [];
            for (let i = 0; i < ganttTotalDays; i++) {
                const date = new Date(ganttStartDate);
                date.setDate(ganttStartDate.getDate() + i);
                timelineDates.push(date);
            }

            // --- 1. ヘッダー行の描画 ---
            let headerHtml = `<div class="gantt-header header-project">案件名</div>`;
            timelineDates.forEach(date => {
                const day = date.getDay(); // 0:Sun, 6:Sat
                let dayClass = '';
                if (day === 0) dayClass = 'day-sun';
                if (day === 6) dayClass = 'day-sat';
                headerHtml += `
                    <div class="gantt-header ${dayClass}">
                        ${date.getDate()}/${date.getMonth() + 1}
                    </div>
                `;
            });

            // --- 2. データ行の描画 ---
            let rowsHtml = '';
            projectsMockData.forEach(p => {
                
                // プロジェクトの開始日・終了日とガントチャート開始日の差を計算
                // (カラム番号は 1-based だが、案件名列が 1 なので、日付は 2 からスタート)
                const ganttStartStr = toISODateString(ganttStartDate);
                
                // 開始日がガントチャートより早い場合は 1 (日付列の最初)
                let startCol = Math.max(1, daysBetween(ganttStartStr, p.orderDate));
                // 終了日
                let endCol = daysBetween(ganttStartStr, p.deadline) + 1; // +1 でその日を含む

                // ガントチャートの範囲内に丸める
                startCol = Math.max(1, startCol);
                endCol = Math.min(ganttTotalDays + 1, endCol);

                // CSS Grid は 1-based index。 案件名列が 1 なので、日付列は 2 から (ganttTotalDays + 1) まで。
                const cssVarStart = startCol + 1; // +1 は案件名列の分
                const cssVarEnd = endCol + 1;     // +1 は案件名列の分

                rowsHtml += `
                    <div class="gantt-row">
                        <div class="gantt-project-name">${p.name}</div>
                        
                        ${timelineDates.map(() => `<div class="gantt-day-cell"></div>`).join('')}
                        
                        <div class="gantt-bar ${p.status.class}" 
                             style="--gantt-start: ${cssVarStart}; --gantt-end: ${cssVarEnd};">
                            ${p.name}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = headerHtml + rowsHtml;
        }

        /**
         * 3. 予算テーブル描画
         */
        function renderBudgetTable() {
            const table = document.getElementById('budget-table');
            const formatter = new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' });
            
            // --- 1. ヘッダー行 ---
            let html = `
                <thead>
                    <tr>
                        <th class="col-project">案件名</th>
                        <th class="col-number">予算</th>
                        <th class="col-number">実績</th>
                        <th class="col-number">差異</th>
                    </tr>
                </thead>
            `;

            // --- 2. データ行 ---
            html += `<tbody>`;
            projectsMockData.forEach(p => {
                const budget = p.budget || 0;
                const actual = p.actual || 0;
                const diff = budget - actual;
                let diffClass = '';
                if (diff > 0) diffClass = 'diff-plus'; // 予算余り
                if (diff < 0) diffClass = 'diff-minus'; // 予算オーバー
                
                html += `
                    <tr>
                        <td>
                            <span class="status-badge ${p.status.class}">${p.status.text}</span>
                            <strong>${p.name}</strong>
                            <div class="project-category-badge">${p.client}</div>
                        </td>
                        <td class="col-number">${formatter.format(budget)}</td>
                        <td class="col-number">${formatter.format(actual)}</td>
                        <td class="col-number ${diffClass}">${formatter.format(diff)}</td>
                    </tr>
                `;
            });
            html += `</tbody>`;
            
            table.innerHTML = html;
        }
        
        /**
         * (変更) 4. 担当者テーブル描画 (削除)
         */
        // function renderAssigneeTable() { ... }

        // --- ▲▲▲ 新規ビュー描画関数 ここまで ▲▲▲ ---


        // --- 初期表示 (全ビューを描画) ---
        renderProjectCards();
        renderGanttChart();
        renderBudgetTable();
        // (変更) renderAssigneeTable(); // 削除


        // --- 既存の検索フィルター (簡易版) ---
        document.getElementById('projectSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            // (注: 検索は現在カードビューにのみ連動)
            const cards = cardContainer.querySelectorAll('.card');
            cards.forEach(card => {
                const cardText = card.textContent.toLowerCase();
                if (cardText.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // --- (変更) ビュー切替リスナー ---
        const toggleButtons = document.querySelectorAll('.view-toggle-btn');
        const viewContents = document.querySelectorAll('.view-content');

        toggleButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-view-target');

                // 1. 全てのボタンの 'active' を解除
                toggleButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-checked', 'false');
                });

                // 2. クリックしたボタンを 'active' に
                button.classList.add('active');
                button.setAttribute('aria-checked', 'true');

                // 3. 全てのビューを非表示
                viewContents.forEach(content => {
                    content.style.display = 'none';
                    content.classList.remove('active');
                });

                // 4. 対象のビューを表示
                const targetView = document.getElementById(targetId);
                if (targetView) {
                    targetView.style.display = 'block'; // 'block' で表示
                    targetView.classList.add('active');
                }
            });
        });

    </script>
        <script src="constants.js"></script>
    <script src="layout.js" defer></script>
</body>
</html>